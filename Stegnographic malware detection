import hashlib
import os
import sys
import requests

# Your VirusTotal API key
API_KEY = 'YOUR API KEY HERE'

def extract_and_hash(image_file):
    # Use binwalk to extract zip and 7z directories
    os.system(f"binwalk -e '{image_file}' --run-as=root")

    # Get a list of extracted directories
    extracted_dirs = [f for f in os.listdir() if f.startswith('_') and os.path.isdir(f)]

    # List to store file paths and hashes
    file_info = []

    # Iterate over the extracted directories
    for dir_name in extracted_dirs:
        # Iterate over the files in the directory
        for root, dirs, files in os.walk(dir_name):
            for file_name in files:
                file_path = os.path.join(root, file_name)
                # Calculate the hash value for the file
                with open(file_path, 'rb') as f:
                    file_hash = hashlib.sha256(f.read()).hexdigest()
                file_info.append((file_path, file_hash))
                print(f"File: {file_path}, Hash: {file_hash}")

    return file_info

def generate_report(file_info):
    url = f'https://www.virustotal.com/vtapi/v2/file/report'
    for file_path, file_hash in file_info:
        params = {'apikey': API_KEY, 'resource': file_hash}
        response = requests.get(url, params=params)
        result = response.json()
        print(f"\nVirusTotal Scan Results for {file_path}:")
        if result['response_code'] == 0:
            print("Hash not found in VirusTotal database")
        else:
            for key, value in result['scans'].items():
                print(f"{key}: {value['result']}")

if _name_ == "_main_":
    if len(sys.argv) != 2:
        print("Usage: python script.py <image_file>")
        sys.exit(1)

    image_file = sys.argv[1]
    file_info = extract_and_hash(image_file)
    if file_info:
        generate_report(file_info)
